<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Create stratified residual diagnostic plots — plot_stratified_residuals • halfmoon</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Create stratified residual diagnostic plots — plot_stratified_residuals"><meta name="description" content="Create diagnostic plots to assess differences between treatment group after adjustment.
This function plots residuals
from an outcome model against propensity scores (or fitted values),
stratified by treatment group, to reveal model mis-specification."><meta property="og:description" content="Create diagnostic plots to assess differences between treatment group after adjustment.
This function plots residuals
from an outcome model against propensity scores (or fitted values),
stratified by treatment group, to reveal model mis-specification."><meta property="og:image" content="https://r-causal.github.io/halfmoon/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">halfmoon</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-causal/halfmoon/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Create stratified residual diagnostic plots</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-causal/halfmoon/blob/main/R/plot_stratified_residuals.R" class="external-link"><code>R/plot_stratified_residuals.R</code></a></small>
      <div class="d-none name"><code>plot_stratified_residuals.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Create diagnostic plots to assess differences between treatment group after adjustment.
This function plots residuals
from an outcome model against propensity scores (or fitted values),
stratified by treatment group, to reveal model mis-specification.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">plot_stratified_residuals</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'lm'</span></span>
<span><span class="fu">plot_stratified_residuals</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">treatment</span>,</span>
<span>  ps_model <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"color"</span>, <span class="st">"facet"</span>, <span class="st">"both"</span><span class="op">)</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  smooth_span <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'glm'</span></span>
<span><span class="fu">plot_stratified_residuals</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">treatment</span>,</span>
<span>  ps_model <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"color"</span>, <span class="st">"facet"</span>, <span class="st">"both"</span><span class="op">)</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  smooth_span <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'data.frame'</span></span>
<span><span class="fu">plot_stratified_residuals</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">treatment</span>,</span>
<span>  <span class="va">residuals</span>,</span>
<span>  <span class="va">x_var</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"color"</span>, <span class="st">"facet"</span>, <span class="st">"both"</span><span class="op">)</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  smooth_span <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>Either a fitted model object (lm or glm) or a data frame</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to methods</p></dd>


<dt id="arg-treatment">treatment<a class="anchor" aria-label="anchor" href="#arg-treatment"></a></dt>
<dd><p>A vector indicating treatment group membership.
Must have exactly two unique levels. For data frames, can be
an unquoted column name.</p></dd>


<dt id="arg-ps-model">ps_model<a class="anchor" aria-label="anchor" href="#arg-ps-model"></a></dt>
<dd><p>Optional propensity score model (glm object).
If provided, uses propensity scores instead of fitted values.</p></dd>


<dt id="arg-plot-type">plot_type<a class="anchor" aria-label="anchor" href="#arg-plot-type"></a></dt>
<dd><p>Character; type of plot - "color" (default), "facet", or "both".</p><ul><li><p>"color": Single plot with points colored by treatment</p></li>
<li><p>"facet": Separate facets for each treatment group</p></li>
<li><p>"both": Both color and faceting</p></li>
</ul></dd>


<dt id="arg-smooth">smooth<a class="anchor" aria-label="anchor" href="#arg-smooth"></a></dt>
<dd><p>Logical; whether to add loess smoothing curves. Default is TRUE.</p></dd>


<dt id="arg-smooth-span">smooth_span<a class="anchor" aria-label="anchor" href="#arg-smooth-span"></a></dt>
<dd><p>Numeric; span parameter for loess smoothing. Default is 1.</p></dd>


<dt id="arg-alpha">alpha<a class="anchor" aria-label="anchor" href="#arg-alpha"></a></dt>
<dd><p>Numeric; transparency level for points. Default is 0.25.</p></dd>


<dt id="arg-na-rm">na.rm<a class="anchor" aria-label="anchor" href="#arg-na-rm"></a></dt>
<dd><p>Logical; if TRUE, remove missing values before plotting.</p></dd>


<dt id="arg-residuals">residuals<a class="anchor" aria-label="anchor" href="#arg-residuals"></a></dt>
<dd><p>Column containing residuals. Supports tidyselect syntax.</p></dd>


<dt id="arg-x-var">x_var<a class="anchor" aria-label="anchor" href="#arg-x-var"></a></dt>
<dd><p>Column for x-axis values (fitted values or propensity scores).
Supports tidyselect syntax.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A ggplot2 object</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This diagnostic plot was originally suggested by Rosenbaum and Rubin (1983)
and revisited by D'Agostino McGowan, D'Agostino, and D'Agostino (2023).
The key idea is that plotting residuals against propensity scores
or fitted values by treatment group can reveal non-linear relationships or
heterogeneous treatment effects that might be obscured in standard
residuals-vs-fitted plots.</p>
<p>The function supports two approaches:</p><ul><li><p>For regression models (lm/glm): Extracts residuals and fitted values automatically</p></li>
<li><p>For data frames: Uses specified columns for residuals, treatment, and x-axis values</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>

<ul><li><p>Rosenbaum, P. R., &amp; Rubin, D. B. (1983). The central role of the
propensity score in observational studies for causal effects.
Biometrika, 70(1), 41-55.</p></li>
<li><p>D'Agostino McGowan, L., D'Agostino, R. B, Sr., &amp; D'Agostino, R. B, Jr. (2023).
A Visual Diagnostic Tool for Causal Inference. Observational Studies,
9(1), 87-95.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><code><a href="plot_model_calibration.html">plot_model_calibration()</a></code> for calibration plots</p></li>
<li><p><code><a href="plot_model_roc_curve.html">plot_model_roc_curve()</a></code> for ROC curves</p></li>
<li><p><code><a href="plot_qq.html">plot_qq()</a></code> for QQ plots</p></li>
</ul></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate data with treatment effect heterogeneity</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co"># True propensity score</span></span></span>
<span class="r-in"><span><span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">ps</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y1</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y0</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">treatment</span> <span class="op">*</span> <span class="va">y1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">treatment</span><span class="op">)</span> <span class="op">*</span> <span class="va">y0</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Method 1: Using model objects</span></span></span>
<span class="r-in"><span><span class="co"># Fit misspecified model (missing interaction)</span></span></span>
<span class="r-in"><span><span class="va">model_wrong</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot with fitted values</span></span></span>
<span class="r-in"><span><span class="fu">plot_stratified_residuals</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">model_wrong</span>,</span></span>
<span class="r-in"><span>  treatment <span class="op">=</span> <span class="va">treatment</span>,</span></span>
<span class="r-in"><span>  plot_type <span class="op">=</span> <span class="st">"both"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot with propensity scores</span></span></span>
<span class="r-in"><span><span class="va">ps_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">x</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">plot_stratified_residuals</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">model_wrong</span>,</span></span>
<span class="r-in"><span>  treatment <span class="op">=</span> <span class="va">treatment</span>,</span></span>
<span class="r-in"><span>  ps_model <span class="op">=</span> <span class="va">ps_model</span>,</span></span>
<span class="r-in"><span>  plot_type <span class="op">=</span> <span class="st">"color"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Method 2: Using data frame</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  treatment <span class="op">=</span> <span class="va">treatment</span>,</span></span>
<span class="r-in"><span>  residuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">model_wrong</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  fitted_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">model_wrong</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  propensity_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">ps_model</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">plot_stratified_residuals</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">plot_data</span>,</span></span>
<span class="r-in"><span>  treatment <span class="op">=</span> <span class="va">treatment</span>,</span></span>
<span class="r-in"><span>  residuals <span class="op">=</span> <span class="va">residuals</span>,</span></span>
<span class="r-in"><span>  x_var <span class="op">=</span> <span class="va">propensity_score</span>,</span></span>
<span class="r-in"><span>  plot_type <span class="op">=</span> <span class="st">"facet"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Malcolm Barrett.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

