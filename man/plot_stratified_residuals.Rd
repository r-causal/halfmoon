% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot_stratified_residuals.R
\name{plot_stratified_residuals}
\alias{plot_stratified_residuals}
\title{Create stratified residual diagnostic plots}
\usage{
plot_stratified_residuals(
  .model = NULL,
  .residuals = NULL,
  .ps_or_fitted = NULL,
  .treatment = NULL,
  plot_type = c("color", "facet", "both"),
  smooth = TRUE,
  smooth_span = 1,
  alpha = 0.25,
  x_label = NULL,
  na.rm = FALSE
)
}
\arguments{
\item{.model}{A fitted model object (e.g., from \code{lm()} or \code{glm()}).
If provided, residuals and fitted values are extracted automatically.}

\item{.residuals}{A numeric vector of residuals. Required if \code{.model} is NULL.}

\item{.ps_or_fitted}{A numeric vector of propensity scores or fitted values
to plot on the x-axis. Required if \code{.model} is NULL.}

\item{.treatment}{A vector indicating treatment group membership.
Must have exactly two unique levels.}

\item{plot_type}{Character; type of plot - "color" (default), "facet", or "both".
\itemize{
\item "color": Single plot with points colored by treatment
\item "facet": Separate facets for each treatment group
\item "both": Both color and faceting
}}

\item{smooth}{Logical; whether to add loess smoothing curves. Default is TRUE.}

\item{smooth_span}{Numeric; span parameter for loess smoothing. Default is 1.}

\item{alpha}{Numeric; transparency level for points. Default is 0.25.}

\item{x_label}{Character; label for x-axis. Default is "Propensity score"
if using propensity scores, or "Fitted values" otherwise.}

\item{na.rm}{Logical; if TRUE, remove missing values before plotting.}
}
\value{
A ggplot2 object.
}
\description{
Create diagnostic plots to assess whether covariate adjustment adequately
controls confounding in observational studies. This function plots residuals
from an outcome model against propensity scores (or fitted values),
stratified by treatment group, to reveal model mis-specification.
}
\details{
This diagnostic plot was originally suggested by Rosenbaum and Rubin (1983)
and revisited by McGowan-D'Agostino, D'Agostino, and D'Agostino (2023).
The key idea is that plotting residuals against propensity scores
(rather than fitted values) can reveal non-linear relationships or
heterogeneous treatment effects that might be obscured in standard
residuals-vs-fitted plots.

The function accepts either:
\itemize{
\item A fitted model object, from which it extracts residuals and fitted values
\item Separate vectors of residuals and propensity scores/fitted values
}
}
\examples{
\dontrun{
library(ggplot2)

# Simulate data with treatment effect heterogeneity
set.seed(8)
n <- 1000
x <- rnorm(n)
ps <- plogis(x)  # True propensity score
treatment <- rbinom(n, 1, ps)
y1 <- 0.5 * x + rnorm(n)
y0 <- -0.5 * x + rnorm(n)
y <- treatment * y1 + (1 - treatment) * y0

# Fit misspecified model (missing interaction)
model_wrong <- lm(y ~ treatment + x)

# Create diagnostic plot using fitted model
plot_stratified_residuals(
  .model = model_wrong,
  .treatment = treatment,
  plot_type = "both"
)

# Fit correct model with interaction
model_correct <- lm(y ~ treatment * x)

# Compare plots
plot_stratified_residuals(
  .model = model_correct,
  .treatment = treatment,
  plot_type = "both"
)

# Using propensity scores instead of fitted values
ps_model <- glm(treatment ~ x, family = binomial)
ps_fitted <- fitted(ps_model)

plot_stratified_residuals(
  .residuals = residuals(model_wrong),
  .ps_or_fitted = ps_fitted,
  .treatment = treatment,
  plot_type = "color",
  x_label = "Propensity score"
)

# The propensity score plot often reveals patterns more clearly
plot_stratified_residuals(
  .residuals = residuals(model_wrong),
  .ps_or_fitted = ps_fitted,
  .treatment = treatment,
  plot_type = "facet",
  x_label = "Propensity score"
)
}

}
\references{
\itemize{
\item Rosenbaum, P. R., & Rubin, D. B. (1983). The central role of the
propensity score in observational studies for causal effects.
Biometrika, 70(1), 41-55.
\item D'Agostino McGowan, L., D'Agostino, R. B, Sr., & D'Agostino, R. B, Jr. (2023).
A Visual Diagnostic Tool for Causal Inference. Observational Studies,
9(1), 87-95.
}
}
\seealso{
\itemize{
\item \code{\link[=plot_calibration]{plot_calibration()}} for calibration plots
\item \code{\link[=plot_roc_curve]{plot_roc_curve()}} for ROC curves
\item \code{\link[=plot_qq]{plot_qq()}} for QQ plots
}
}
